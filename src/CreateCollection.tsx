import { Button, Grid } from '@mui/material'
import {
  AptosClient,
  FaucetClient,
  HexString,
  TokenClient,
  TransactionBuilder,
  TransactionBuilderABI
} from 'aptos'
import { Uint64 } from 'aptos/dist/transaction_builder/bcs/types'
import { AptosPublicKey } from './types'
import {
  AccountAddress,
  ChainId,
  EntryFunction,
  RawTransaction,
  StructTag,
  TransactionPayloadEntryFunction,
  TypeTagStruct
} from 'aptos/dist/transaction_builder/aptos_types'
import { NightlyWalletAdapter } from './nightly'
import { PendingTransaction } from 'aptos/dist/generated'
import { fenecImages, TOKEN_ABIS } from './utils/const'

const TESTNET_URL = 'https://fullnode.devnet.aptoslabs.com'
const FAUCET_URL = 'https://faucet.devnet.aptoslabs.com'

const sleep = milliseconds => {
  return new Promise(resolve => setTimeout(resolve, milliseconds))
}
export const CreateCollectionButton: React.FC<{
  userPublicKey: AptosPublicKey | undefined
  NightlyAptos: NightlyWalletAdapter
}> = ({ userPublicKey, NightlyAptos }) => {
  const aptosClient = new AptosClient(TESTNET_URL)
  const transactionBuilderABI = new TransactionBuilderABI(
    TOKEN_ABIS.map(abi => new HexString(abi).toUint8Array())
  )
  const NUMBER_ITEMS = 25
  const createCollection = async () => {
    if (!userPublicKey) return
    const faucetClient = new FaucetClient(TESTNET_URL, FAUCET_URL)
    faucetClient.fundAccount(userPublicKey.address(), 1_000_000)
    faucetClient.fundAccount(userPublicKey.address(), 1_000_000)
    faucetClient.fundAccount(userPublicKey.address(), 1_000_000)
    faucetClient.fundAccount(userPublicKey.address(), 1_000_000)
    faucetClient.fundAccount(userPublicKey.address(), 1_000_000)
    faucetClient.fundAccount(userPublicKey.address(), 1_000_000)
    faucetClient.fundAccount(userPublicKey.address(), 1_000_000)
    faucetClient.fundAccount(userPublicKey.address(), 1_000_000)
    const collectionName = 'Funny Fennec ' + (Math.floor(Math.random() * 1000) + 1).toString()
    try {
      const createCollectionPayload = transactionBuilderABI.buildTransactionPayload(
        '0x3::token::create_collection_script',
        [],
        [
          collectionName,
          'We invite you to test Nightly Wallet"',
          'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSWEkIQ_TH_lgwJa6M5k4zUJM2QDOS0LmLoCg&usqp=CAU',
          10000,
          [false, false, false]
        ]
      )
      const [{ sequence_number: sequnceNumber }, chainId] = await Promise.all([
        aptosClient.getAccount(userPublicKey.address()),
        aptosClient.getChainId()
      ])
      const rawTxn = new RawTransaction(
        AccountAddress.fromHex(userPublicKey.address()),
        BigInt(sequnceNumber),
        createCollectionPayload,
        BigInt(2000),
        BigInt(1),
        BigInt(Math.floor(Date.now() / 1000) + 120),
        new ChainId(chainId)
      )
      const signedTx = await NightlyAptos.signTransaction(rawTxn)
      const arrayCreateTokens: RawTransaction[] = []

      const result = await aptosClient.submitSignedBCSTransaction(signedTx)
      console.log('Create collection : ', result)
      await sleep(500)

      for (let x = 0; x < NUMBER_ITEMS; x++) {
        const tokenName = 'Fennec ' + x.toString()
        const createTokenPayload = transactionBuilderABI.buildTransactionPayload(
          '0x3::token::create_token_script',
          [],
          [
            collectionName,
            tokenName,
            'Amazing NFTs generated by aptos_template',
            1,
            1,
            fenecImages[x % fenecImages.length],
            userPublicKey.address(),
            10,
            1,
            [false, false, false, false, true],
            ['Test', 'Data'],
            [
              'Nightly',
              `${new Date().getDay()}/${new Date().getMonth()}/${new Date().getFullYear()}`
            ],
            ['string', 'string']
          ]
        )

        const rawTxn = new RawTransaction(
          AccountAddress.fromHex(userPublicKey.address()),
          BigInt(+sequnceNumber + +x + 1),
          createTokenPayload,
          BigInt(2000),
          BigInt(1),
          BigInt(Math.floor(Date.now() / 1000) + 120),
          new ChainId(chainId)
        )
        arrayCreateTokens.push(rawTxn)
      }

      const signedTxsCreate = await NightlyAptos.signAllTransactions(arrayCreateTokens)
      const promiseCreate: Array<Promise<PendingTransaction>> = []

      const arrayMutableTokens: RawTransaction[] = []
      for (const signedCreateTx of signedTxsCreate) {
        await sleep(1000)
        promiseCreate.push(aptosClient.submitSignedBCSTransaction(signedCreateTx))
      }

      for (let x = 0; x < NUMBER_ITEMS; x++) {
        const tokenName = 'Fennec ' + x.toString()
        const mutableTokenPayload = transactionBuilderABI.buildTransactionPayload(
          '0x3::token::mutate_token_properties',
          [],
          [
            userPublicKey.address(),
            userPublicKey.address(),
            collectionName,
            tokenName,
            0,
            1,
            ['Test', 'Data'],
            [
              'Nightly mutable',
              `${new Date().getDay() + 1}/${new Date().getMonth()}/${new Date().getFullYear()}`
            ],
            ['string', 'string']
          ]
        )

        const rawTxnMutable = new RawTransaction(
          AccountAddress.fromHex(userPublicKey.address()),
          BigInt(+sequnceNumber + x + NUMBER_ITEMS + 1),
          mutableTokenPayload,
          BigInt(2000),
          BigInt(1),
          BigInt(Math.floor(Date.now() / 1000) + 120),
          new ChainId(chainId)
        )

        arrayMutableTokens.push(rawTxnMutable)
      }

      const signedTxsMutable = await NightlyAptos.signAllTransactions(arrayMutableTokens)
      const promise: Array<Promise<PendingTransaction>> = []
      for (const signedMutableTx of signedTxsMutable) {
        await sleep(1000)
        promise.push(aptosClient.submitSignedBCSTransaction(signedMutableTx))
      }

      const mutableResults = await Promise.all(promise)
      console.log('Modified', mutableResults)
    } catch (error) {
      console.log(error)
    }
  }

  return (
    <Grid item>
      <Button
        variant='contained'
        style={{ margin: 10 }}
        onClick={async () => {
          await createCollection()
        }}>
        Create Collection with {NUMBER_ITEMS} items
      </Button>
    </Grid>
  )
}
